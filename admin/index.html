<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5" />
<title>Battle Bros Admin - Content Editor</title>
<meta name="robots" content="noindex, nofollow" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Righteous&family=Bebas+Neue&display=swap" rel="stylesheet" />

<style>
/* ==================== CSS VARIABLES ==================== */
:root {
  --primary: #00d9ff;
  --secondary: #ff00ea;
  --accent: #ffed00;
  --bg-dark: #0a0a12;
  --bg-panel: #1a1a2e;
  --text: #ffffff;
  --danger: #ff3838;
  --success: #00ff88;
}

/* ==================== RESET ==================== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* ==================== ANIMATIONS ==================== */
@keyframes glitchText {
  0%, 100% { text-shadow: 2px 2px 0 var(--primary), -2px -2px 0 var(--secondary); }
  25% { text-shadow: -2px 2px 0 var(--secondary), 2px -2px 0 var(--primary); }
  50% { text-shadow: 2px -2px 0 var(--primary), -2px 2px 0 var(--secondary); }
  75% { text-shadow: -2px -2px 0 var(--secondary), 2px 2px 0 var(--primary); }
}

@keyframes scanline {
  0% { transform: translateY(-100%); }
  100% { transform: translateY(100%); }
}

@keyframes neonPulse {
  0%, 100% { box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary); }
  50% { box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); }
}

@keyframes pixelShift {
  0%, 100% { transform: translate(0, 0); }
  25% { transform: translate(2px, 0); }
  50% { transform: translate(0, 2px); }
  75% { transform: translate(-2px, 0); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ==================== BASE LAYOUT ==================== */
html, body {
  background: var(--bg-dark);
  color: var(--text);
  font-family: 'Righteous', cursive;
  min-height: 100vh;
  overflow-x: hidden;
}

body {
  background-image: 
    repeating-linear-gradient(
      0deg,
      rgba(0, 217, 255, 0.03) 0px,
      transparent 1px,
      transparent 2px,
      rgba(0, 217, 255, 0.03) 3px
    );
  position: relative;
}

/* Scanline effect */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    to bottom,
    transparent 50%,
    rgba(0, 217, 255, 0.05) 50%
  );
  background-size: 100% 4px;
  pointer-events: none;
  z-index: 9999;
  animation: scanline 8s linear infinite;
}

/* ==================== LOGIN SCREEN ==================== */
#loginScreen {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
}

.login-container {
  background: var(--bg-panel);
  border: 2px solid var(--primary);
  border-radius: 10px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
  animation: fadeIn 0.5s ease-out;
}

.login-title {
  font-family: 'Bebas Neue', cursive;
  font-size: 2.5rem;
  color: var(--primary);
  text-align: center;
  margin-bottom: 10px;
  animation: glitchText 3s ease-in-out infinite;
}

.login-subtitle {
  text-align: center;
  color: var(--accent);
  font-size: 0.9rem;
  margin-bottom: 30px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.login-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-label {
  font-size: 0.9rem;
  color: var(--primary);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.form-input {
  background: var(--bg-dark);
  border: 2px solid var(--primary);
  color: var(--text);
  padding: 12px 16px;
  font-family: 'Righteous', cursive;
  font-size: 1rem;
  border-radius: 5px;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  box-shadow: 0 0 15px rgba(0, 217, 255, 0.5);
  animation: neonPulse 1s ease-in-out infinite;
}

.btn-primary {
  background: var(--primary);
  color: var(--bg-dark);
  border: none;
  padding: 14px 24px;
  font-family: 'Bebas Neue', cursive;
  font-size: 1.3rem;
  letter-spacing: 2px;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.3s ease;
  text-transform: uppercase;
  font-weight: bold;
}

.btn-primary:hover {
  background: var(--accent);
  box-shadow: 0 0 20px rgba(255, 237, 0, 0.6);
  transform: translateY(-2px);
}

.btn-primary:active {
  transform: translateY(0);
}

.error-message {
  background: var(--danger);
  color: var(--text);
  padding: 12px;
  border-radius: 5px;
  text-align: center;
  font-size: 0.9rem;
  animation: pixelShift 0.3s ease-in-out;
}

/* ==================== ADMIN DASHBOARD ==================== */
#adminDashboard {
  display: none;
  min-height: 100vh;
}

.admin-header {
  background: var(--bg-panel);
  border-bottom: 2px solid var(--primary);
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.admin-title {
  font-family: 'Bebas Neue', cursive;
  font-size: 2rem;
  color: var(--primary);
  animation: glitchText 5s ease-in-out infinite;
}

.admin-nav {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.btn-secondary {
  background: transparent;
  border: 2px solid var(--secondary);
  color: var(--secondary);
  padding: 8px 16px;
  font-family: 'Righteous', cursive;
  font-size: 0.9rem;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.3s ease;
  text-transform: uppercase;
}

.btn-secondary:hover {
  background: var(--secondary);
  color: var(--bg-dark);
  box-shadow: 0 0 15px rgba(255, 0, 234, 0.5);
}

.btn-logout {
  background: transparent;
  border: 2px solid var(--danger);
  color: var(--danger);
  padding: 8px 16px;
  font-family: 'Righteous', cursive;
  font-size: 0.9rem;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.3s ease;
  text-transform: uppercase;
}

.btn-logout:hover {
  background: var(--danger);
  color: var(--text);
  box-shadow: 0 0 15px rgba(255, 56, 56, 0.5);
}

.admin-content {
  padding: 30px 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.section {
  background: var(--bg-panel);
  border: 2px solid var(--primary);
  border-radius: 10px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
}

.section-title {
  font-family: 'Bebas Neue', cursive;
  font-size: 1.8rem;
  color: var(--accent);
  margin-bottom: 20px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.chapter-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.chapter-item {
  background: var(--bg-dark);
  border: 2px solid var(--primary);
  border-radius: 5px;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
  transition: all 0.3s ease;
}

.chapter-item:hover {
  box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
  transform: translateX(5px);
}

.chapter-info {
  flex: 1;
  min-width: 200px;
}

.chapter-name {
  font-size: 1.2rem;
  color: var(--primary);
  margin-bottom: 5px;
}

.chapter-meta {
  font-size: 0.85rem;
  color: var(--text);
  opacity: 0.7;
}

.chapter-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.btn-small {
  padding: 6px 12px;
  font-size: 0.8rem;
  border-radius: 3px;
  border: none;
  cursor: pointer;
  font-family: 'Righteous', cursive;
  transition: all 0.3s ease;
  text-transform: uppercase;
}

.btn-edit {
  background: var(--primary);
  color: var(--bg-dark);
}

.btn-edit:hover {
  box-shadow: 0 0 10px var(--primary);
}

.btn-delete {
  background: transparent;
  border: 1px solid var(--danger);
  color: var(--danger);
}

.btn-delete:hover {
  background: var(--danger);
  color: var(--text);
}

.btn-add {
  background: var(--accent);
  color: var(--bg-dark);
  padding: 12px 24px;
  font-size: 1rem;
  margin-top: 20px;
}

.btn-add:hover {
  box-shadow: 0 0 20px var(--accent);
}

/* ==================== EDITOR MODAL ==================== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 18, 0.95);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
  overflow-y: auto;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--bg-panel);
  border: 2px solid var(--primary);
  border-radius: 10px;
  padding: 30px;
  max-width: 600px;
  width: 100%;
  box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
  animation: fadeIn 0.3s ease-out;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title {
  font-family: 'Bebas Neue', cursive;
  font-size: 1.8rem;
  color: var(--primary);
}

.btn-close {
  background: transparent;
  border: none;
  color: var(--danger);
  font-size: 2rem;
  cursor: pointer;
  line-height: 1;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-close:hover {
  color: var(--text);
}

.form-editor {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.page-list {
  background: var(--bg-dark);
  border: 2px solid var(--primary);
  border-radius: 5px;
  padding: 15px;
  max-height: 300px;
  overflow-y: auto;
}

.page-item {
  background: var(--bg-panel);
  border: 1px solid var(--primary);
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 3px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}

.page-path {
  font-size: 0.85rem;
  color: var(--text);
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
}

.btn-remove {
  background: transparent;
  border: 1px solid var(--danger);
  color: var(--danger);
  padding: 4px 8px;
  font-size: 0.7rem;
  cursor: pointer;
  border-radius: 3px;
}

.btn-remove:hover {
  background: var(--danger);
  color: var(--text);
}

.btn-add-page {
  background: var(--accent);
  color: var(--bg-dark);
  padding: 8px 16px;
  font-size: 0.9rem;
  margin-top: 10px;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.btn-save {
  background: var(--success);
  color: var(--bg-dark);
  padding: 10px 24px;
  font-size: 1rem;
  border: none;
  cursor: pointer;
  border-radius: 5px;
  font-family: 'Bebas Neue', cursive;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.btn-save:hover {
  box-shadow: 0 0 20px var(--success);
}

.btn-cancel {
  background: transparent;
  border: 2px solid var(--text);
  color: var(--text);
  padding: 10px 24px;
  font-size: 1rem;
  cursor: pointer;
  border-radius: 5px;
  font-family: 'Bebas Neue', cursive;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.btn-cancel:hover {
  background: var(--text);
  color: var(--bg-dark);
}

/* ==================== PREVIEW SECTION ==================== */
.preview-container {
  background: var(--bg-dark);
  border: 2px solid var(--accent);
  border-radius: 5px;
  padding: 20px;
  margin-top: 20px;
}

.preview-title {
  font-family: 'Bebas Neue', cursive;
  font-size: 1.3rem;
  color: var(--accent);
  margin-bottom: 15px;
}

.preview-data {
  background: var(--bg-panel);
  border: 1px solid var(--primary);
  border-radius: 3px;
  padding: 15px;
  font-family: monospace;
  font-size: 0.85rem;
  color: var(--primary);
  overflow-x: auto;
  max-height: 400px;
  overflow-y: auto;
}

.export-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.btn-copy {
  background: var(--primary);
  color: var(--bg-dark);
}

.btn-download {
  background: var(--secondary);
  color: var(--text);
}

.success-message {
  background: var(--success);
  color: var(--bg-dark);
  padding: 12px;
  border-radius: 5px;
  text-align: center;
  margin-top: 15px;
  font-size: 0.9rem;
  animation: fadeIn 0.3s ease-out;
}

/* ==================== IMAGE UPLOAD STYLES ==================== */
.upload-section {
  background: var(--bg-dark);
  border: 2px solid var(--accent);
  border-radius: 5px;
  padding: 15px;
}

.upload-area {
  border: 2px dashed var(--primary);
  border-radius: 5px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: var(--bg-panel);
  min-height: 120px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.upload-area:hover {
  border-color: var(--accent);
  background: rgba(255, 237, 0, 0.05);
}

.upload-area.drag-over {
  border-color: var(--success);
  background: rgba(0, 255, 136, 0.1);
  box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
}

.upload-prompt {
  color: var(--primary);
  pointer-events: none;
}

.upload-preview {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  margin-top: 15px;
  width: 100%;
}

.preview-item {
  position: relative;
  border: 2px solid var(--primary);
  border-radius: 5px;
  overflow: hidden;
  aspect-ratio: 1;
  background: var(--bg-dark);
}

.preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.preview-item .preview-name {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(10, 10, 18, 0.9);
  color: var(--text);
  font-size: 0.7rem;
  padding: 4px;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.preview-item .preview-remove {
  position: absolute;
  top: 5px;
  right: 5px;
  background: var(--danger);
  color: var(--text);
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 0.9rem;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.preview-item .preview-remove:hover {
  background: var(--text);
  color: var(--danger);
}

.upload-progress {
  margin-top: 15px;
  background: var(--bg-panel);
  border: 2px solid var(--primary);
  border-radius: 5px;
  padding: 15px;
}

.progress-item {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  font-size: 0.85rem;
}

.progress-bar-container {
  flex: 1;
  height: 20px;
  background: var(--bg-dark);
  border: 1px solid var(--primary);
  border-radius: 3px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  transition: width 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  color: var(--bg-dark);
  font-weight: bold;
}

.progress-status {
  min-width: 80px;
  text-align: right;
}

.progress-status.success {
  color: var(--success);
}

.progress-status.error {
  color: var(--danger);
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
  .admin-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .admin-title {
    font-size: 1.5rem;
  }
  
  .chapter-item {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .modal-content {
    padding: 20px;
  }
  
  .login-container {
    padding: 30px 20px;
  }
}
</style>
</head>
<body>

<!-- ==================== LOGIN SCREEN ==================== -->
<div id="loginScreen">
  <div class="login-container">
    <h1 class="login-title">ADMIN ACCESS</h1>
    <p class="login-subtitle">Battle Bros Editor</p>
    <form id="loginForm" class="login-form">
      <div class="form-group">
        <label class="form-label" for="password">Password</label>
        <input 
          type="password" 
          id="password" 
          class="form-input" 
          placeholder="Enter admin password"
          required
        />
      </div>
      <button type="submit" class="btn-primary">Login</button>
    </form>
    <div id="loginError" style="display: none; margin-top: 15px;"></div>
  </div>
</div>

<!-- ==================== ADMIN DASHBOARD ==================== -->
<div id="adminDashboard">
  <header class="admin-header">
    <h1 class="admin-title">Battle Bros Admin</h1>
    <nav class="admin-nav">
      <button class="btn-secondary" id="btnSettings">‚öôÔ∏è Settings</button>
      <button class="btn-secondary" id="btnPreview">Preview Changes</button>
      <button class="btn-primary" id="btnPublish">üöÄ Publish to GitHub</button>
      <button class="btn-logout" id="btnLogout">Logout</button>
    </nav>
  </header>

  <main class="admin-content">
    <!-- Chapter Management Section -->
    <section class="section">
      <h2 class="section-title">Chapter Management</h2>
      <div id="chapterList" class="chapter-list"></div>
      <button class="btn-small btn-add" id="btnAddChapter">+ Add New Chapter</button>
    </section>

    <!-- Preview/Export Section -->
    <section class="section" id="previewSection" style="display: none;">
      <h2 class="section-title">Preview & Export</h2>
      <div class="preview-container">
        <h3 class="preview-title">Chapter Data (JSON)</h3>
        <pre id="previewData" class="preview-data"></pre>
        <div class="export-actions">
          <button class="btn-small btn-copy" id="btnCopy">Copy to Clipboard</button>
          <button class="btn-small btn-download" id="btnDownload">Download JSON</button>
        </div>
        <div id="copySuccess" style="display: none;"></div>
      </div>
      <p style="margin-top: 20px; color: var(--accent); font-size: 0.9rem;">
        üìù <strong>Instructions:</strong> Copy this JSON and replace the "chapters" object in index.html (around line 1762)
      </p>
    </section>
  </main>
</div>

<!-- ==================== EDIT CHAPTER MODAL ==================== -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Edit Chapter</h2>
      <button class="btn-close" id="btnCloseModal">&times;</button>
    </div>
    <form id="editForm" class="form-editor">
      <div class="form-group">
        <label class="form-label" for="chapterName">Chapter Name</label>
        <input 
          type="text" 
          id="chapterName" 
          class="form-input" 
          placeholder="e.g., Chapter 1"
          required
        />
      </div>
      
      <div class="form-group">
        <label class="form-label">Pages (Image Paths)</label>
        <div id="pageList" class="page-list"></div>
        
        <!-- Upload Section -->
        <div class="upload-section" style="margin-top: 15px;">
          <label class="form-label">Upload New Images</label>
          <div class="upload-area" id="uploadArea">
            <input 
              type="file" 
              id="imageUpload" 
              accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
              multiple
              style="display: none;"
            />
            <div class="upload-prompt" id="uploadPrompt">
              <p>üìÅ Click to browse or drag & drop images here</p>
              <p style="font-size: 0.8rem; opacity: 0.7;">Supports: PNG, JPG, GIF, WebP</p>
            </div>
            <div id="uploadPreview" class="upload-preview"></div>
          </div>
          <button type="button" class="btn-small btn-add-page" id="btnUploadImages" style="display: none;">
            ‚¨ÜÔ∏è Upload Selected Images
          </button>
          <div id="uploadProgress" class="upload-progress" style="display: none;"></div>
        </div>
        
        <!-- Manual Path Entry (keep existing) -->
        <div style="margin-top: 15px;">
          <button type="button" class="btn-small btn-add-page" id="btnAddPage">+ Add Manual Path</button>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn-cancel" id="btnCancelEdit">Cancel</button>
        <button type="submit" class="btn-save">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- ==================== SETTINGS MODAL ==================== -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">GitHub Settings</h2>
      <button class="btn-close" id="btnCloseSettings">&times;</button>
    </div>
    <div class="form-editor">
      <div class="form-group">
        <label class="form-label">Your GitHub Personal Access Token</label>
        <input 
          type="password" 
          id="githubToken" 
          class="form-input" 
          placeholder="ghp_xxxxxxxxxxxx"
        />
        <p style="font-size: 0.8rem; color: var(--accent); margin-top: 5px;">
          ‚ö†Ô∏è This token is stored in your browser only and never sent to the server.
          <br>Create one at: <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary);">github.com/settings/tokens</a>
          <br>Required scope: <strong>repo</strong>
        </p>
      </div>
      <button class="btn-save" id="btnSaveToken">Save Token</button>
      <div id="tokenSaveSuccess" style="display: none; margin-top: 10px;"></div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ==================== STATE MANAGEMENT ====================
  const ADMIN_PASSWORD = 'battlebros2024'; // TODO: Use more secure auth in production
  const STORAGE_KEY = 'battlebros_admin_data';
  const SESSION_KEY = 'battlebros_admin_session';
  const GITHUB_TOKEN_KEY = 'battlebros_github_user_token';

  // GitHub API Configuration
  const GITHUB_CONFIG = {
    owner: 'bwondercomics',
    repo: 'battle-bros-reader-dev',
    branch: 'main', // Testing on this branch
    dataFile: 'admin/data.json'
  };

  let chapters = {};
  let currentEditingChapter = null;
  
  // Image upload state
  let selectedFiles = [];
  let uploadQueue = [];

  // ==================== DOM ELEMENTS ====================
  const el = {
    loginScreen: document.getElementById('loginScreen'),
    loginForm: document.getElementById('loginForm'),
    loginError: document.getElementById('loginError'),
    adminDashboard: document.getElementById('adminDashboard'),
    chapterList: document.getElementById('chapterList'),
    btnAddChapter: document.getElementById('btnAddChapter'),
    btnLogout: document.getElementById('btnLogout'),
    btnSettings: document.getElementById('btnSettings'),
    btnPreview: document.getElementById('btnPreview'),
    btnPublish: document.getElementById('btnPublish'),
    previewSection: document.getElementById('previewSection'),
    previewData: document.getElementById('previewData'),
    btnCopy: document.getElementById('btnCopy'),
    btnDownload: document.getElementById('btnDownload'),
    copySuccess: document.getElementById('copySuccess'),
    editModal: document.getElementById('editModal'),
    modalTitle: document.getElementById('modalTitle'),
    editForm: document.getElementById('editForm'),
    chapterName: document.getElementById('chapterName'),
    pageList: document.getElementById('pageList'),
    btnAddPage: document.getElementById('btnAddPage'),
    btnCloseModal: document.getElementById('btnCloseModal'),
    btnCancelEdit: document.getElementById('btnCancelEdit'),
    settingsModal: document.getElementById('settingsModal'),
    btnCloseSettings: document.getElementById('btnCloseSettings'),
    githubToken: document.getElementById('githubToken'),
    btnSaveToken: document.getElementById('btnSaveToken'),
    tokenSaveSuccess: document.getElementById('tokenSaveSuccess')
  };

  // ==================== AUTHENTICATION ====================
  
  async function checkSession() {
    const session = sessionStorage.getItem(SESSION_KEY);
    if (session === 'authenticated') {
      await showDashboard();
      return true;
    }
    return false;
  }

  async function login(password) {
    if (password === ADMIN_PASSWORD) {
      sessionStorage.setItem(SESSION_KEY, 'authenticated');
      await showDashboard();
      return true;
    }
    return false;
  }

  function logout() {
    sessionStorage.removeItem(SESSION_KEY);
    el.loginScreen.style.display = 'flex';
    el.adminDashboard.style.display = 'none';
    document.getElementById('password').value = '';
  }

  async function showDashboard() {
    el.loginScreen.style.display = 'none';
    el.adminDashboard.style.display = 'block';
    await loadChapters();
    renderChapterList();
    initUploadHandlers();
  }

  // ==================== DATA MANAGEMENT ====================
  
  async function loadChapters() {
    // Try to load from data.json first (published data)
    try {
      const response = await fetch('data.json');
      if (response.ok) {
        const data = await response.json();
        if (data.chapters && typeof data.chapters === 'object') {
          chapters = data.chapters;
          console.log('‚úì Loaded chapter data from data.json');
          return;
        }
      }
    } catch (e) {
      console.warn('Could not load from data.json, trying localStorage:', e);
    }
    
    // Fallback to localStorage (saved drafts)
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        chapters = JSON.parse(saved);
        console.log('‚úì Loaded chapter data from localStorage');
        return;
      } catch (e) {
        console.error('Error loading saved data:', e);
      }
    }
    
    // Final fallback: empty chapters (user can add new ones)
    console.warn('No chapter data found, starting with empty chapters');
    chapters = {};
  }

  function saveChapters() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(chapters));
  }

  // ==================== UI RENDERING ====================
  
  function renderChapterList() {
    el.chapterList.innerHTML = '';
    
    const chapterNames = Object.keys(chapters);
    chapterNames.forEach((name, index) => {
      const pages = chapters[name];
      const item = document.createElement('div');
      item.className = 'chapter-item';
      item.innerHTML = `
        <div class="chapter-info">
          <div class="chapter-name">${escapeHtml(name)}</div>
          <div class="chapter-meta">${pages.length} pages</div>
        </div>
        <div class="chapter-actions">
          <button class="btn-small btn-edit" data-chapter="${escapeHtml(name)}">Edit</button>
          <button class="btn-small btn-delete" data-chapter="${escapeHtml(name)}">Delete</button>
        </div>
      `;
      el.chapterList.appendChild(item);
    });
    
    // Attach event listeners
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', () => editChapter(btn.dataset.chapter));
    });
    
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => deleteChapter(btn.dataset.chapter));
    });
  }

  function renderPageList(pages) {
    el.pageList.innerHTML = '';
    
    pages.forEach((path, index) => {
      const item = document.createElement('div');
      item.className = 'page-item';
      item.innerHTML = `
        <span class="page-path">${escapeHtml(path)}</span>
        <button class="btn-remove" data-index="${index}" data-path="${escapeHtml(path)}">Remove</button>
      `;
      el.pageList.appendChild(item);
    });
    
    // Attach event listeners
    document.querySelectorAll('.btn-remove').forEach(btn => {
      btn.addEventListener('click', () => removePage(parseInt(btn.dataset.index), btn.dataset.path));
    });
  }

  // ==================== CHAPTER OPERATIONS ====================
  
  function editChapter(chapterName) {
    currentEditingChapter = chapterName;
    el.modalTitle.textContent = 'Edit Chapter';
    el.chapterName.value = chapterName;
    renderPageList(chapters[chapterName] || []);
    showModal();
  }

  function addNewChapter() {
    currentEditingChapter = null;
    el.modalTitle.textContent = 'Add New Chapter';
    el.chapterName.value = '';
    renderPageList([]);
    showModal();
  }

  function deleteChapter(chapterName) {
    if (confirm(`Are you sure you want to delete "${chapterName}"?`)) {
      delete chapters[chapterName];
      saveChapters();
      renderChapterList();
    }
  }

  function saveChapterEdit() {
    const newName = el.chapterName.value.trim();
    if (!newName) {
      alert('Chapter name is required');
      return;
    }
    
    // Get all pages
    const pages = [];
    el.pageList.querySelectorAll('.page-path').forEach(span => {
      const path = span.textContent.trim();
      if (path) pages.push(path);
    });
    
    // Delete old chapter if name changed
    if (currentEditingChapter && currentEditingChapter !== newName) {
      delete chapters[currentEditingChapter];
    }
    
    // Save new/updated chapter
    chapters[newName] = pages;
    saveChapters();
    renderChapterList();
    hideModal();
  }

  function addPage() {
    const path = prompt('Enter image path (e.g., chapters/01/01.png):');
    if (path) {
      const currentPages = [];
      el.pageList.querySelectorAll('.page-path').forEach(span => {
        currentPages.push(span.textContent.trim());
      });
      currentPages.push(path.trim());
      renderPageList(currentPages);
    }
  }

  async function removePage(index, imagePath) {
    const currentPages = [];
    el.pageList.querySelectorAll('.page-path').forEach(span => {
      currentPages.push(span.textContent.trim());
    });
    
    // Check if user has GitHub token configured
    const token = localStorage.getItem(GITHUB_TOKEN_KEY);
    
    if (token) {
      // Show confirmation dialog with option to permanently delete
      const message = `What would you like to do with "${imagePath}"?\n\n` +
        `‚ö†Ô∏è WARNING: Permanent deletion cannot be undone!\n\n` +
        `Click OK to PERMANENTLY DELETE from GitHub\n` +
        `Click Cancel to just remove from chapter list`;
      
      const deleteFromGitHub = confirm(message);
      
      if (deleteFromGitHub) {
        // User wants to permanently delete from GitHub
        const deleteBtn = document.querySelector(`[data-index="${index}"]`);
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.textContent = 'Deleting...';
        }
        
        try {
          await deleteImageFromGitHub(imagePath, token);
          alert(`‚úì Image "${imagePath}" has been permanently deleted from GitHub!`);
        } catch (error) {
          console.error('Delete error:', error);
          alert(`Failed to delete image from GitHub:\n\n${error.message}\n\nThe image will still be removed from the chapter list.`);
        }
      }
    }
    
    // Remove from chapter list (regardless of GitHub deletion result)
    currentPages.splice(index, 1);
    renderPageList(currentPages);
  }

  // ==================== IMAGE UPLOAD HANDLERS ====================

  function initUploadHandlers() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('imageUpload');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const uploadPreview = document.getElementById('uploadPreview');
    const btnUploadImages = document.getElementById('btnUploadImages');

    // Click to browse
    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    // File selection
    fileInput.addEventListener('change', (e) => {
      handleFileSelect(e.target.files);
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('drag-over');
      handleFileSelect(e.dataTransfer.files);
    });

    // Upload button
    btnUploadImages.addEventListener('click', () => {
      uploadImagesToGitHub();
    });
  }

  function handleFileSelect(files) {
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB limit
    
    const uploadPrompt = document.getElementById('uploadPrompt');
    const uploadPreview = document.getElementById('uploadPreview');
    const btnUploadImages = document.getElementById('btnUploadImages');

    // Filter for valid image files
    const imageFiles = Array.from(files).filter(file => {
      if (!file.type.startsWith('image/')) {
        return false;
      }
      if (file.size > MAX_FILE_SIZE) {
        showError(`File ${file.name} is too large (max 10MB)`);
        return false;
      }
      return true;
    });

    if (imageFiles.length === 0) {
      showError('Please select valid image files (PNG, JPG, GIF, WebP) under 10MB');
      return;
    }

    // Add to selected files (avoid duplicates)
    imageFiles.forEach(file => {
      const exists = selectedFiles.find(f => f.name === file.name && f.size === file.size);
      if (!exists) {
        selectedFiles.push(file);
      }
    });

    // Update UI
    uploadPrompt.style.display = selectedFiles.length > 0 ? 'none' : 'block';
    btnUploadImages.style.display = selectedFiles.length > 0 ? 'block' : 'none';

    renderFilePreview();
  }

  function renderFilePreview() {
    const uploadPreview = document.getElementById('uploadPreview');
    uploadPreview.innerHTML = '';

    selectedFiles.forEach((file, index) => {
      const reader = new FileReader();
      
      reader.onload = (e) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        previewItem.innerHTML = `
          <img src="${e.target.result}" alt="${file.name}">
          <div class="preview-name" title="${file.name}">${file.name}</div>
          <button class="preview-remove" data-index="${index}" title="Remove">√ó</button>
        `;
        
        // Remove button handler
        previewItem.querySelector('.preview-remove').addEventListener('click', (evt) => {
          evt.stopPropagation();
          removeSelectedFile(index);
        });
        
        uploadPreview.appendChild(previewItem);
      };
      
      reader.readAsDataURL(file);
    });
  }

  function removeSelectedFile(index) {
    selectedFiles.splice(index, 1);
    
    const uploadPrompt = document.getElementById('uploadPrompt');
    const btnUploadImages = document.getElementById('btnUploadImages');
    
    uploadPrompt.style.display = selectedFiles.length > 0 ? 'none' : 'block';
    btnUploadImages.style.display = selectedFiles.length > 0 ? 'block' : 'none';
    
    renderFilePreview();
  }

  function clearSelectedFiles() {
    selectedFiles = [];
    const uploadPrompt = document.getElementById('uploadPrompt');
    const uploadPreview = document.getElementById('uploadPreview');
    const btnUploadImages = document.getElementById('btnUploadImages');
    const fileInput = document.getElementById('imageUpload');
    
    uploadPrompt.style.display = 'block';
    uploadPreview.innerHTML = '';
    btnUploadImages.style.display = 'none';
    fileInput.value = '';
  }

  // ==================== GITHUB API - FILE UPLOAD ====================

  async function uploadImagesToGitHub() {
    const token = localStorage.getItem(GITHUB_TOKEN_KEY);
    
    if (!token) {
      showError('Please configure your GitHub token in Settings first.');
      document.getElementById('btnSettings').click();
      return;
    }

    if (!currentEditingChapter) {
      showError('No chapter is currently being edited.');
      return;
    }

    if (selectedFiles.length === 0) {
      showError('No files selected for upload.');
      return;
    }

    const uploadProgress = document.getElementById('uploadProgress');
    const btnUploadImages = document.getElementById('btnUploadImages');
    
    uploadProgress.style.display = 'block';
    uploadProgress.innerHTML = '';
    btnUploadImages.disabled = true;
    btnUploadImages.textContent = 'Uploading...';

    const results = [];
    
    for (let i = 0; i < selectedFiles.length; i++) {
      const file = selectedFiles[i];
      const result = await uploadSingleImage(file, i + 1, selectedFiles.length, token);
      results.push(result);
    }

    // Check if all succeeded
    const allSuccess = results.every(r => r.success);
    
    if (allSuccess) {
      // Add all uploaded paths to current chapter
      results.forEach(r => {
        if (r.path && !chapters[currentEditingChapter].includes(r.path)) {
          chapters[currentEditingChapter].push(r.path);
        }
      });
      
      saveChapters();
      renderPageList(chapters[currentEditingChapter]);
      clearSelectedFiles();
      
      showSuccess(`Successfully uploaded ${results.length} image(s)!`);
      
      setTimeout(() => {
        uploadProgress.style.display = 'none';
      }, 3000);
    } else {
      const failedCount = results.filter(r => !r.success).length;
      showError(`${failedCount} of ${results.length} uploads failed. Check the progress details.`);
    }

    btnUploadImages.disabled = false;
    btnUploadImages.textContent = '‚¨ÜÔ∏è Upload Selected Images';
  }

  async function uploadSingleImage(file, index, total, token) {
    const progressItem = document.createElement('div');
    progressItem.className = 'progress-item';
    progressItem.innerHTML = `
      <span>${file.name}</span>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" style="width: 0%">0%</div>
      </div>
      <span class="progress-status">Uploading...</span>
    `;
    
    document.getElementById('uploadProgress').appendChild(progressItem);
    const progressBar = progressItem.querySelector('.progress-bar-fill');
    const progressStatus = progressItem.querySelector('.progress-status');

    try {
      // Generate file path
      const chapterNumber = currentEditingChapter.match(/\d+/)?.[0] || '01';
      const chapterFolder = `chapters/${chapterNumber.padStart(2, '0')}`;
      
      // Get next available number in chapter
      const existingPages = chapters[currentEditingChapter] || [];
      const existingNumbers = existingPages
        .filter(p => p.startsWith(chapterFolder))
        .map(p => {
          const match = p.match(/\/(\d+)\.(png|jpg|jpeg|gif|webp)$/i);
          return match ? parseInt(match[1]) : 0;
        })
        .filter(n => !isNaN(n));
      
      const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
      const fileExt = file.name.split('.').pop().toLowerCase();
      const fileName = `${nextNumber.toString().padStart(2, '0')}.${fileExt}`;
      const filePath = `${chapterFolder}/${fileName}`;

      // Read file as base64
      progressBar.style.width = '30%';
      progressBar.textContent = '30%';
      const base64Content = await readFileAsBase64(file);

      // Upload to GitHub
      progressBar.style.width = '60%';
      progressBar.textContent = '60%';
      
      const response = await fetch(
        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`,
        {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: `Add ${fileName} to ${currentEditingChapter}`,
            content: base64Content,
            branch: GITHUB_CONFIG.branch
          })
        }
      );

      progressBar.style.width = '100%';
      progressBar.textContent = '100%';

      if (response.ok) {
        progressStatus.textContent = '‚úì Success';
        progressStatus.classList.add('success');
        return { success: true, path: filePath, file: file.name };
      } else {
        const error = await response.json();
        throw new Error(error.message || 'Upload failed');
      }

    } catch (error) {
      console.error('Upload error:', error);
      progressBar.style.width = '100%';
      progressBar.textContent = 'Failed';
      progressBar.style.background = 'var(--danger)';
      progressStatus.textContent = `‚úó ${error.message}`;
      progressStatus.classList.add('error');
      return { success: false, error: error.message, file: file.name };
    }
  }

  // ==================== GITHUB API - FILE DELETION ====================

  async function getFileSha(filePath, token) {
    const response = await fetch(
      `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}?ref=${GITHUB_CONFIG.branch}`,
      {
        headers: { 
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    if (!response.ok) {
      if (response.status === 404) {
        throw new Error('File not found in repository');
      }
      const error = await response.json();
      throw new Error(error.message || 'Failed to fetch file information');
    }
    
    const data = await response.json();
    return data.sha;
  }

  async function deleteImageFromGitHub(filePath, token) {
    try {
      // Step 1: Get file SHA (required for deletion)
      const sha = await getFileSha(filePath, token);
      
      // Step 2: Delete the file
      const response = await fetch(
        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`,
        {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify({
            message: `Delete ${filePath} via admin panel`,
            sha: sha,
            branch: GITHUB_CONFIG.branch
          })
        }
      );
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Delete operation failed');
      }
      
      return true;
    } catch (error) {
      console.error('GitHub delete error:', error);
      throw error;
    }
  }

  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        // Remove data URL prefix (data:image/png;base64,)
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function showError(message) {
    // Reuse existing error display or create alert
    alert('ERROR: ' + message);
  }

  function showSuccess(message) {
    // Reuse existing success display or create alert
    alert('SUCCESS: ' + message);
  }

  // ==================== MODAL MANAGEMENT ====================
  
  function showModal() {
    el.editModal.classList.add('active');
  }

  function hideModal() {
    el.editModal.classList.remove('active');
    currentEditingChapter = null;
    clearSelectedFiles();
  }

  // ==================== PREVIEW & EXPORT ====================
  
  function showPreview() {
    const jsonData = JSON.stringify(chapters, null, 2);
    el.previewData.textContent = jsonData;
    el.previewSection.style.display = 'block';
    el.previewSection.scrollIntoView({ behavior: 'smooth' });
  }

  function copyToClipboard() {
    const jsonData = JSON.stringify(chapters, null, 2);
    navigator.clipboard.writeText(jsonData).then(() => {
      el.copySuccess.textContent = '‚úì Copied to clipboard!';
      el.copySuccess.className = 'success-message';
      el.copySuccess.style.display = 'block';
      setTimeout(() => {
        el.copySuccess.style.display = 'none';
      }, 3000);
    }).catch(err => {
      alert('Failed to copy: ' + err);
    });
  }

  function downloadJSON() {
    const jsonData = JSON.stringify(chapters, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'battle-bros-chapters.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ==================== GITHUB INTEGRATION ====================
  
  function showSettingsModal() {
    el.settingsModal.classList.add('active');
    // Load existing token (partially masked)
    const token = localStorage.getItem(GITHUB_TOKEN_KEY);
    if (token) {
      el.githubToken.value = token;
    }
  }

  function hideSettingsModal() {
    el.settingsModal.classList.remove('active');
  }

  function saveGitHubToken() {
    const token = el.githubToken.value.trim();
    if (!token) {
      alert('Please enter a valid GitHub token');
      return;
    }
    
    localStorage.setItem(GITHUB_TOKEN_KEY, token);
    el.tokenSaveSuccess.textContent = '‚úì Token saved successfully!';
    el.tokenSaveSuccess.className = 'success-message';
    el.tokenSaveSuccess.style.display = 'block';
    
    setTimeout(() => {
      el.tokenSaveSuccess.style.display = 'none';
      hideSettingsModal();
    }, 2000);
  }

  async function publishToGitHub() {
    const token = localStorage.getItem(GITHUB_TOKEN_KEY);
    
    if (!token) {
      if (confirm('GitHub token not found. Would you like to configure it now?')) {
        showSettingsModal();
      }
      return;
    }
    
    // Confirm publish
    if (!confirm('Are you sure you want to publish these changes to GitHub? This will update the live website.')) {
      return;
    }
    
    const publishBtn = el.btnPublish;
    const originalText = publishBtn.textContent;
    
    try {
      publishBtn.disabled = true;
      publishBtn.textContent = '‚è≥ Publishing...';
      
      // Prepare data
      const dataToCommit = {
        chapters: chapters,
        lastUpdated: new Date().toISOString(),
        publishedBy: 'Admin Panel'
      };
      
      // Get current file SHA (required for updates)
      let sha = null;
      try {
        const currentFile = await fetch(
          `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}?ref=${GITHUB_CONFIG.branch}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          }
        );
        
        if (currentFile.ok) {
          const fileData = await currentFile.json();
          sha = fileData.sha;
        }
      } catch (e) {
        console.log('File may not exist yet, creating new file');
      }
      
      // Commit the file
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(dataToCommit, null, 2)))); // Base64 encode with UTF-8 support
      
      const response = await fetch(
        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`,
        {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Update chapters via Admin Panel - ${new Date().toISOString()}`,
            content: content,
            branch: GITHUB_CONFIG.branch,
            ...(sha && { sha: sha }) // Include SHA only if updating existing file
          })
        }
      );
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API error: ${response.status} - ${errorData.message || 'Unknown error'}`);
      }
      
      publishBtn.textContent = '‚úÖ Published!';
      alert('‚úÖ Published successfully!\n\nGitHub Action is updating the site.\nCheck back in 1-2 minutes.\n\nView workflow status at:\nhttps://github.com/bwondercomics/battle-bros-reader/actions');
      
      // Reset button after delay
      setTimeout(() => {
        publishBtn.textContent = originalText;
        publishBtn.disabled = false;
      }, 3000);
      
    } catch (error) {
      console.error('Publish error:', error);
      publishBtn.textContent = originalText;
      publishBtn.disabled = false;
      alert(`‚ùå Publish failed:\n\n${error.message}\n\nPlease check:\n1. Your GitHub token has 'repo' permissions\n2. You have access to the repository\n3. Your internet connection is working`);
    }
  }

  // ==================== UTILITIES ====================
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ==================== EVENT HANDLERS ====================
  
  function attachEventHandlers() {
    // Login
    el.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      if (!(await login(password))) {
        el.loginError.textContent = 'Invalid password';
        el.loginError.className = 'error-message';
        el.loginError.style.display = 'block';
      }
    });

    // Logout
    el.btnLogout.addEventListener('click', logout);

    // Add chapter
    el.btnAddChapter.addEventListener('click', addNewChapter);

    // Modal controls
    el.btnCloseModal.addEventListener('click', hideModal);
    el.btnCancelEdit.addEventListener('click', hideModal);
    el.editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      saveChapterEdit();
    });

    // Page management
    el.btnAddPage.addEventListener('click', addPage);

    // Preview & export
    el.btnPreview.addEventListener('click', showPreview);
    el.btnCopy.addEventListener('click', copyToClipboard);
    el.btnDownload.addEventListener('click', downloadJSON);

    // GitHub integration
    el.btnSettings.addEventListener('click', showSettingsModal);
    el.btnCloseSettings.addEventListener('click', hideSettingsModal);
    el.btnSaveToken.addEventListener('click', saveGitHubToken);
    el.btnPublish.addEventListener('click', publishToGitHub);

    // Close modals on backdrop click
    el.editModal.addEventListener('click', (e) => {
      if (e.target === el.editModal) {
        hideModal();
      }
    });
    
    el.settingsModal.addEventListener('click', (e) => {
      if (e.target === el.settingsModal) {
        hideSettingsModal();
      }
    });
  }

  // ==================== INITIALIZATION ====================
  
  async function init() {
    attachEventHandlers();
    if (!(await checkSession())) {
      el.loginScreen.style.display = 'flex';
      el.adminDashboard.style.display = 'none';
    }
    console.log('‚úì Battle Bros Admin initialized');
  }

  // ==================== START ====================
  
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(init, 0);
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }

})();
</script>
</body>
</html>
